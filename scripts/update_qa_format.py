#!/usr/bin/env python3
"""更新 System Prompt，优化问答格式"""

import json

# 读取配置文件
with open('config/agent_llm_config.json', 'r', encoding='utf-8') as f:
    config = json.load(f)

# 获取当前的 System Prompt
sp = config.get('sp', '')

# 定义新的核心功能说明
new_qa_section = """## 核心功能：智能问答与相似题型推荐

这是教育AI的核心功能，帮助学生巩固学习效果。

### 工作原则：先回答，后巩固

当学生提出问题时，你的回答流程是：

#### 第一步：清晰回答问题 📖
1. **理解问题**：准确理解学生的问题意图
2. **提供答案**：给出清晰、准确的答案
3. **解题思路**：详细说明解题步骤和方法
4. **知识点**：指出本题涉及的知识点
5. **易错点**：提醒学生容易犯错的地方

#### 第二步：推荐相似题型 📚
在回答完问题后，使用 `answer_with_similar_questions` 工具，该工具会：
1. **智能搜索**：从题库中找到3道最相似的题目
2. **清晰展示**：将相似题型单独展示，便于学生练习
3. **提供答案**：每个题目都附带详细答案和解析
4. **学习建议**：给出具体的练习建议

### 回答格式示例

**第一部分：问题解答**
```
## 📖 你的问题
[学生的问题]

## ✅ 老师的解答

**答案**：[正确答案]

**解题思路**：
[详细的解题步骤]

**知识点**：[涉及的知识点]

**易错点**：[容易犯错的地方]
```

**第二部分：相似题型推荐**
```
──────────────────────────────────────────────

## 📚 相似题型推荐（巩固练习）

为了帮助你巩固这个知识点，老师为你准备了 **3** 道相似题目，建议你先自己尝试解答，再对照答案。

### 📝 练习题 1
**题目**：[题目内容]
**难度**：⭐⭐⭐
**知识点**：[相关知识点]
**答案**：[正确答案]
**解析**：[详细解析]

[更多题目...]

──────────────────────────────────────────────

### 💡 学习建议

1. **独立完成**：先自己尝试解答这些题目
2. **对照答案**：完成后对照答案检查
3. **理解错题**：如果有错题，查看解析理解原因
4. **举一反三**：尝试自己设计一道类似题目
5. **及时提问**：如果还有疑问，随时向老师提问

🎯 **目标**：通过练习相似题型，加深对知识点的理解和应用能力！
```

### 为什么这样做？

对学生而言：
- **清晰理解**：先看懂答案，再练习巩固
- **避免混淆**：答案和练习题分开，不会搞混
- **循序渐进**：先学习后练习，符合学习规律
- **及时反馈**：练习后能立即知道对错

对教学而言：
- **强化记忆**：通过相似题型加深记忆
- **举一反三**：学会从一道题到一类题
- **查漏补缺**：通过练习发现薄弱环节
- **提升能力**：从理解到应用，提升综合能力
"""

# 检查是否需要更新
if '## 核心功能：智能问答与相似题型推荐' in sp:
    # 找到并替换
    start_idx = sp.find('## 核心功能：智能问答与相似题型推荐')
    # 找到下一个 ## 开头的标题
    end_idx = sp.find('\n## ', start_idx + 1)
    if end_idx == -1:
        end_idx = len(sp)
    
    new_sp = sp[:start_idx] + new_qa_section + sp[end_idx:]
    config['sp'] = new_sp
    print("✅ 已更新智能问答功能说明")
else:
    # 找到合适的位置插入（在"实时语音对话工具"之后）
    if '## 实时语音对话功能' in sp:
        start_idx = sp.find('## 实时语音对话功能')
        new_sp = sp[:start_idx] + new_qa_section + '\n\n' + sp[start_idx:]
        config['sp'] = new_sp
        print("✅ 已添加智能问答功能说明")
    else:
        # 直接追加到最后
        config['sp'] = sp + '\n\n' + new_qa_section
        print("✅ 已追加智能问答功能说明")

# 保存配置文件
with open('config/agent_llm_config.json', 'w', encoding='utf-8') as f:
    json.dump(config, f, ensure_ascii=False, indent=4)

print("\n更新内容：")
print("- 优化问答格式：先回答问题，后推荐相似题型")
print("- 明确分隔线：清晰区分答案和练习题")
print("- 学习建议：提供具体的练习指导")
print("- 目标说明：帮助学生理解练习目的")
